<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Student Answers</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%; /* Limits overall width on larger screens */
            margin: 0 auto; /* Centers the content */
            padding: 15px; /* Slightly reduced padding for mobile */
            box-sizing: border-box; /* Include padding in element's total width */
        }

        .student-info {
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center; /* Center student info */
        }

        /* Styles for the camera activation button */
        .camera-activation {
            text-align: center;
            margin: 20px 0;
        }

        #activateCameraBtn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

            #activateCameraBtn:hover {
                background: #0056b3;
            }

        /* Styles for the camera feed and container */
        .camera-container {
            position: relative;
            width: 100%; /* Takes full width of its parent */
            max-width: 97%; /* Limits max width on larger screens */
            margin: 0 auto;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex; /* Use flexbox for centering content */
            flex-direction: column; /* Stack content vertically */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
            min-height: 500px; /* Ensure visibility even without stream, adjust as needed */
            aspect-ratio: 4/3; /* Maintain a common aspect ratio for video */
        }

        #cameraFeed {
            width: 100%;
            height: 100%; /* Take full height of container */
            display: block;
            background-color: #000;
            object-fit: contain; /* Ensures entire video frame is visible */
        }

        .camera-placeholder {
            color: #fff;
            font-size: 1.1em;
            text-align: center;
            padding: 20px;
        }

        /* Take photo button - simplified white circle */
        #takePhotoBtn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            background: white;
            border: 4px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            z-index: 10;
        }

            #takePhotoBtn:hover {
                transform: translateX(-50%) scale(1.1);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
            }

            #takePhotoBtn:active {
                transform: translateX(-50%) scale(0.95);
            }

            #takePhotoBtn:disabled {
                background: #ccc;
                border-color: #ccc;
                cursor: not-allowed;
                opacity: 0.6;
            }

                #takePhotoBtn:disabled:hover {
                    transform: translateX(-50%) scale(1);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                }

        /* Flash effect for photo capture */
        .camera-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
        }

            .camera-flash.active {
                animation: flashEffect 0.3s ease-out;
            }

        @keyframes flashEffect {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                opacity: 0;
            }
        }

        .upload-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px; /* Slightly adjusted padding */
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%; /* Make buttons full width */
            box-sizing: border-box; /* Include padding in width */
        }

            .upload-btn:hover {
                background: #0056b3;
            }

            .upload-btn:disabled {
                background: #6c757d;
                cursor: not-allowed;
            }

        /* Main upload button at the bottom */
        #uploadBtn {
            margin-top: 20px;
            margin-bottom: 10px;
            width: 100%; /* Ensure it's full width */
            max-width: 400px; /* Limit max width on larger screens */
            display: block; /* Ensure it takes full width */
            margin-left: auto; /* Center it */
            margin-right: auto; /* Center it */
        }

        .preview-container {
            display: grid;
            /* On mobile, show 2 columns, scaling down to 1 if necessary */
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preview-item {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
        }

            .preview-item img {
                width: 100%;
                height: 100px; /* Fixed height for consistency */
                object-fit: cover; /* Cover the area, cropping if necessary */
            }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8); /* Slightly transparent red */
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px; /* Slightly larger for easier tapping */
            height: 28px;
            cursor: pointer;
            font-size: 16px; /* Larger font for 'x' */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.95em;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        /* Media query for larger screens */
        @media (min-width: 600px) {
            .preview-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* More columns on wider screens */
            }

            .preview-item img {
                height: 120px; /* Slightly taller previews on larger screens */
            }

            #uploadBtn {
                max-width: 300px; /* Slightly smaller max-width for main button on larger screens */
            }
        }
    </style>
</head>
<body>

    <div id="studentInfo" class="student-info">Loading...</div>

    <div id="cameraActivation" class="camera-activation">
        <button id="activateCameraBtn" class="upload-btn">
            Activate Camera
        </button>
    </div>

    <div id="cameraContainer" class="camera-container hidden">
        <video id="cameraFeed" autoplay playsinline class="hidden"></video>
        <div id="cameraPlaceholder" class="camera-placeholder">
            Attempting to start camera...
        </div>
        <canvas id="cameraCanvas" class="hidden"></canvas> <!-- Hidden canvas for capturing frames -->
        <button id="takePhotoBtn" disabled></button>
        <div class="camera-flash" id="cameraFlash"></div>
    </div>

    <button id="uploadBtn" class="upload-btn" disabled>
        Upload All New Images
    </button>

    <div id="noImagesMessage" class="status-info">
        No images uploaded yet. Use the camera to capture the student's answer sheets.
    </div>

    <div id="imagePreviews" class="preview-container"></div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://uagiatfoiwusxafxskvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhZ2lhdGZvaXd1c3hhZnhza3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyODc0NjYsImV4cCI6MjA2NDg2MzQ2Nn0.b0wIEHgENkhzkp3qHAotqbLTq7BwsqgM7b0ksAl3h1U';
        const STORAGE_BUCKET = 'exam-visuals';

        // Initialize Supabase client
        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let scanSessionId = null;
        let sessionToken = null;
        // Stores objects like { id: uuid, type: 'new'|'uploaded', data: File|string }
        let allImagesForSession = [];
        let cameraStream = null;

        // DOM elements
        const studentInfo = document.getElementById('studentInfo');
        const imagePreviews = document.getElementById('imagePreviews');
        const uploadBtn = document.getElementById('uploadBtn');
        const noImagesMessage = document.getElementById('noImagesMessage');

        const cameraActivation = document.getElementById('cameraActivation');
        const activateCameraBtn = document.getElementById('activateCameraBtn');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraFeed = document.getElementById('cameraFeed');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const cameraFlash = document.getElementById('cameraFlash');

        // Utility to generate a unique ID for local image management
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Show status messages (removed - keeping function for compatibility)
        function showStatus(message, type) {
            // Status messages removed per user request
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            sessionToken = urlParams.get('token');

            if (!sessionToken) {
                studentInfo.textContent = 'Error: No session token provided.';
                return;
            }

            try {
                // Fetch scan session details using the Edge Function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/get-scan-session?token=${sessionToken}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load session');
                }

                const session = await response.json();

                scanSessionId = session.id;

                // Populate allImagesForSession with existing uploaded images from the session
                if (session.uploaded_image_paths && session.uploaded_image_paths.length > 0) {
                    allImagesForSession = session.uploaded_image_paths.map(url => ({
                        id: generateUUID(), // Assign a new ID for local management
                        type: 'uploaded',
                        data: url
                    }));
                }

                studentInfo.textContent = `Student: ${session.student_name || session.student_number || 'Unknown'}`;
                renderPreviews(); // Display existing images
                updateNoImagesMessage(); // Update message based on images
                updateUploadButton(); // Update upload button state

            } catch (error) {
                console.error('Initialization error:', error);
                studentInfo.textContent = `Error: ${error.message}`;
            }
        });

        // Event listeners
        activateCameraBtn.addEventListener('click', activateCamera);
        takePhotoBtn.addEventListener('click', takePhoto);
        uploadBtn.addEventListener('click', uploadImages);

        /**
         * Activates the camera and shows the camera view
         */
        async function activateCamera() {
            cameraActivation.classList.add('hidden');
            cameraContainer.classList.remove('hidden');
            await startCamera();
        }

        /**
         * Starts the camera stream and displays it in the video element.
         */
        async function startCamera() {
            if (cameraStream) {
                return;
            }

            cameraPlaceholder.textContent = 'Attempting to start camera...';

            try {
                // Get available camera devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                console.log('Available cameras:', videoDevices);

                // Find the best rear camera (usually has higher resolution)
                let deviceId = null;
                for (const device of videoDevices) {
                    if (device.label.toLowerCase().includes('back') || 
                        device.label.toLowerCase().includes('rear') ||
                        device.label.toLowerCase().includes('environment')) {
                        deviceId = device.deviceId;
                        break;
                    }
                }

                // Ultra-high quality constraints - push the limits
                const constraints = {
                    video: {
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        facingMode: deviceId ? undefined : 'environment',
                        width: { min: 1920, ideal: 3840, max: 7680 },
                        height: { min: 1080, ideal: 2160, max: 4320 },
                        frameRate: { ideal: 30, max: 60 },
                        focusMode: 'continuous',
                        exposureMode: 'continuous',
                        whiteBalanceMode: 'continuous'
                    }
                };

                let stream;
                try {
                    // Try ultra-high quality first
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (error) {
                    console.warn('Ultra-high quality failed, trying high quality:', error);
                    try {
                        // Fallback to high quality
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                facingMode: 'environment',
                                width: { min: 1280, ideal: 1920, max: 4096 },
                                height: { min: 720, ideal: 1080, max: 4096 },
                                frameRate: { ideal: 30 }
                            }
                        });
                    } catch (error2) {
                        console.warn('High quality failed, trying basic:', error2);
                        // Final fallback
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                facingMode: 'environment',
                                width: { min: 640, ideal: 1280 },
                                height: { min: 480, ideal: 720 }
                            }
                        });
                    }
                }

                cameraStream = stream;
                cameraFeed.srcObject = stream;
                cameraFeed.classList.remove('hidden');
                cameraPlaceholder.classList.add('hidden');
                takePhotoBtn.disabled = false;

                // Log the actual video dimensions and capabilities for debugging
                cameraFeed.addEventListener('loadedmetadata', async () => {
                    console.log('Video dimensions:', cameraFeed.videoWidth, 'x', cameraFeed.videoHeight);
                    
                    // Log camera capabilities
                    const track = stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    const settings = track.getSettings();
                    console.log('Camera capabilities:', capabilities);
                    console.log('Current settings:', settings);
                    
                    // Try to apply advanced settings if supported
                    const advancedConstraints = {};
                    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                        advancedConstraints.focusMode = 'continuous';
                    }
                    if (capabilities.exposureMode && capabilities.exposureMode.includes('continuous')) {
                        advancedConstraints.exposureMode = 'continuous';
                    }
                    if (capabilities.whiteBalanceMode && capabilities.whiteBalanceMode.includes('continuous')) {
                        advancedConstraints.whiteBalanceMode = 'continuous';
                    }
                    
                    if (Object.keys(advancedConstraints).length > 0) {
                        try {
                            await track.applyConstraints(advancedConstraints);
                            console.log('Applied advanced constraints:', advancedConstraints);
                        } catch (error) {
                            console.warn('Could not apply advanced constraints:', error);
                        }
                    }
                });

            } catch (error) {
                console.error('Error accessing camera:', error);
                cameraFeed.classList.add('hidden');
                cameraPlaceholder.classList.remove('hidden');
                cameraPlaceholder.textContent = `Camera access failed: ${error.message}. Please grant permissions.`;
                takePhotoBtn.disabled = true;
            }
        }

        /**
         * Stops the camera stream and releases resources.
         * This function is now primarily for cleanup on page unload, not user interaction.
         */
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                cameraFeed.srcObject = null;
                cameraFeed.classList.add('hidden');
                cameraPlaceholder.classList.remove('hidden');
                cameraPlaceholder.textContent = 'Camera is off.';
                takePhotoBtn.disabled = true;
            }
        }

        /**
         * Captures a photo from the current camera feed.
         */
        function takePhoto() {
            if (!cameraStream) {
                return;
            }

            // Trigger flash effect
            cameraFlash.classList.add('active');
            setTimeout(() => {
                cameraFlash.classList.remove('active');
            }, 300);

            const context = cameraCanvas.getContext('2d');
            
            // Use the maximum possible resolution - either video dimensions or larger
            const maxWidth = Math.max(cameraFeed.videoWidth, 1920);
            const maxHeight = Math.max(cameraFeed.videoHeight, 1080);
            
            cameraCanvas.width = maxWidth;
            cameraCanvas.height = maxHeight;
            
            // Enable image smoothing for better quality
            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = 'high';
            
            // Draw the current video frame onto the canvas with scaling
            context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);

            // Convert canvas content to a Blob with maximum quality
            cameraCanvas.toBlob((blob) => {
                if (blob) {
                    const file = new File([blob], `scan_${Date.now()}.jpg`, { type: 'image/jpeg' });
                    const newImage = {
                        id: generateUUID(),
                        type: 'new', // Mark as a new image, not yet uploaded
                        data: file
                    };
                    allImagesForSession.push(newImage); // Add to our global image list
                    renderPreviews(); // Re-render the preview section
                }
            }, 'image/jpeg', 1.0); // Use maximum quality (100%)
        }

        // Stop camera when navigating away from the page
        window.addEventListener('beforeunload', stopCamera);
        window.addEventListener('pagehide', stopCamera); // For mobile browsers

        /**
         * Renders all images (newly captured and already uploaded) in the preview section.
         */
        function renderPreviews() {
            imagePreviews.innerHTML = ''; // Clear existing previews

            updateNoImagesMessage(); // Update the "No images" message visibility
            updateUploadButton(); // Update the upload button's disabled state

            if (allImagesForSession.length === 0) {
                return; // No images to render
            }

            allImagesForSession.forEach(item => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';

                const img = document.createElement('img');
                // For new images, create an object URL; for uploaded, use the direct URL
                img.src = item.type === 'new' ? URL.createObjectURL(item.data) : item.data;
                img.alt = 'Preview';

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Ã—';
                removeBtn.onclick = () => removeImage(item.id); // Pass the unique ID for removal

                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);

                imagePreviews.appendChild(previewItem);

                // Revoke object URL for 'new' images after they are loaded to free memory
                if (item.type === 'new') {
                    img.onload = () => URL.revokeObjectURL(img.src);
                }
            });
        }

        /**
         * Updates the state of the main "Upload All New Images" button.
         */
        function updateUploadButton() {
            const hasNewImages = allImagesForSession.some(item => item.type === 'new');
            uploadBtn.disabled = !hasNewImages;
        }

        /**
         * Toggles the visibility of the "No images uploaded yet" message.
         */
        function updateNoImagesMessage() {
            const hasImages = allImagesForSession.length > 0;
            noImagesMessage.classList.toggle('hidden', hasImages);
        }

        /**
         * Uploads all newly captured images to Supabase Storage and updates the session record.
         */
        async function uploadImages() {
            const newFilesToUpload = allImagesForSession.filter(item => item.type === 'new');

            if (newFilesToUpload.length === 0) {
                return;
            }

            uploadBtn.disabled = true;
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'Uploading...';

            try {
                const uploadedUrls = [];
                for (const item of newFilesToUpload) {
                    const file = item.data;
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `temp_scans/${sessionToken}/${fileName}`;

                    // Upload file to Supabase Storage
                    const { error: uploadError } = await sb.storage
                        .from(STORAGE_BUCKET)
                        .upload(filePath, file);

                    if (uploadError) throw uploadError;

                    // Get public URL of the uploaded file
                    const { data: urlData } = sb.storage
                        .from(STORAGE_BUCKET)
                        .getPublicUrl(filePath);

                    uploadedUrls.push(urlData.publicUrl);

                    // Update the item's type and data in our local array
                    item.type = 'uploaded';
                    item.data = urlData.publicUrl;
                }

                // Fetch current uploaded_image_paths from DB to merge with new ones
                const { data: currentSessionData, error: fetchError } = await sb
                    .from('scan_sessions')
                    .select('uploaded_image_paths')
                    .eq('id', scanSessionId)
                    .single();

                if (fetchError) throw fetchError;

                const existingPaths = currentSessionData.uploaded_image_paths || [];
                const updatedPaths = [...existingPaths, ...uploadedUrls];

                // Update the scan_sessions table with the merged list of image paths
                const { error: updateError } = await sb
                    .from('scan_sessions')
                    .update({ uploaded_image_paths: updatedPaths })
                    .eq('id', scanSessionId);

                if (updateError) throw updateError;

                renderPreviews(); // Re-render to reflect 'uploaded' status for all images
                updateUploadButton(); // Update button state (should be disabled if no new images)

                // Change button text to show success
                uploadBtn.textContent = 'Images Uploaded Successfully!';
                setTimeout(() => {
                    uploadBtn.textContent = originalText;
                }, 3000);

            } catch (error) {
                console.error('Upload error:', error);
                uploadBtn.textContent = originalText;
            } finally {
                uploadBtn.disabled = false; // Re-enable button in case of failure
            }
        }

        /**
         * Removes an image from the local list and, if uploaded, from Supabase Storage and DB.
         * @param {string} idToRemove - The unique ID of the image to remove.
         */
        async function removeImage(idToRemove) {
            const indexToRemove = allImagesForSession.findIndex(item => item.id === idToRemove);
            if (indexToRemove === -1) return; // Image not found

            const itemToRemove = allImagesForSession[indexToRemove];

            if (itemToRemove.type === 'uploaded') {
                // If it's an already uploaded image, delete from Supabase Storage and DB
                const urlToRemove = itemToRemove.data;
                // Extract filename from the URL to construct the storage path
                const filename = urlToRemove.split('/').pop();
                const filePath = `temp_scans/${sessionToken}/${filename}`;

                try {
                    // Delete from Supabase Storage
                    const { error: deleteError } = await sb.storage.from(STORAGE_BUCKET).remove([filePath]);
                    if (deleteError) throw deleteError;

                    // Fetch current paths from DB to ensure we're updating the latest version
                    const { data: currentSessionData, error: fetchError } = await sb
                        .from('scan_sessions')
                        .select('uploaded_image_paths')
                        .eq('id', scanSessionId)
                        .single();

                    if (fetchError) throw fetchError;

                    const existingPaths = currentSessionData.uploaded_image_paths || [];
                    // Filter out the URL of the image being removed
                    const updatedPaths = existingPaths.filter(path => path !== urlToRemove);

                    // Update the scan_sessions table with the new list of paths
                    const { error: updateError } = await sb
                        .from('scan_sessions')
                        .update({ uploaded_image_paths: updatedPaths })
                        .eq('id', scanSessionId);

                    if (updateError) throw updateError;

                } catch (error) {
                    console.error('Remove image error:', error);
                    return; // Stop if deletion failed
                }
            }

            // Remove from local array and re-render the previews
            allImagesForSession.splice(indexToRemove, 1);
            renderPreviews();
        }
    </script>
</body>
</html>
