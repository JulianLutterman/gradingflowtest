<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Student Answers</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        .student-info {
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }

        /* Styles for the camera activation section */
        .camera-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #007bff;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        }

        .camera-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #007bff;
        }

        .camera-instructions {
            margin-bottom: 20px;
            color: #666;
            font-size: 16px;
            line-height: 1.4;
        }

        .camera-instructions strong {
            color: #333;
        }

        /* Hide the default file inputs */
        #cameraInput, #galleryInput {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        /* Custom camera button */
        .camera-btn {
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 8px;
            text-decoration: none;
        }

        .camera-btn.primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .camera-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .camera-btn.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .camera-btn.secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .camera-btn:active {
            transform: translateY(0);
        }

        .camera-help {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            margin-bottom: 15px;
        }

        .divider {
            color: #999;
            font-weight: bold;
            margin: 20px 0 15px 0;
        }

        .upload-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Main upload button at the bottom */
        #uploadBtn {
            margin-top: 20px;
            margin-bottom: 10px;
            width: 100%;
            max-width: 400px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preview-item {
            position: relative;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .preview-item:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .preview-item .image-info {
            padding: 8px;
            font-size: 12px;
            color: #666;
            text-align: center;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
        }

        .preview-item.new-image {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .preview-item.new-image .image-info {
            color: #28a745;
            font-weight: bold;
        }

        .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.95em;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .image-count {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        .image-count.has-new {
            background: #28a745;
        }

        /* Media query for larger screens */
        @media (min-width: 600px) {
            .preview-container {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }

            .preview-item img {
                height: 140px;
            }

            #uploadBtn {
                max-width: 300px;
            }
        }

        /* Loading animation */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>

    <div id="studentInfo" class="student-info">Loading...</div>

    <div class="camera-section">
        <div class="camera-icon">üì∑</div>
        <div class="camera-instructions">
            <strong>Take High-Quality Photos</strong><br>
            Choose your preferred method below to capture answer sheets.
        </div>
        
        <!-- Primary option: Direct camera capture -->
        <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
        <label for="cameraInput" class="camera-btn primary">
            üì∏ Take Photos Now
        </label>
        
        <div class="camera-help">
            Opens your camera app to take new photos
        </div>
        
        <div class="divider">- OR -</div>
        
        <!-- Secondary option: Browse existing photos -->
        <input type="file" id="galleryInput" accept="image/*" multiple>
        <label for="galleryInput" class="camera-btn secondary">
            üñºÔ∏è Select Existing Photos
        </label>
        
        <div class="camera-help">
            Choose photos you've already taken
        </div>
        
        <div id="imageCount" class="image-count hidden">
            0 photos selected
        </div>
    </div>

    <button id="uploadBtn" class="upload-btn" disabled>
        Upload All New Images
    </button>

    <div id="noImagesMessage" class="status-info">
        No images uploaded yet. Use the camera to capture the student's answer sheets.
    </div>

    <div id="imagePreviews" class="preview-container"></div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://uagiatfoiwusxafxskvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhZ2lhdGZvaXd1c3hhZnhza3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyODc0NjYsImV4cCI6MjA2NDg2MzQ2Nn0.b0wIEHgENkhzkp3qHAotqbLTq7BwsqgM7b0ksAl3h1U';
        const STORAGE_BUCKET = 'exam-visuals';

        // Initialize Supabase client
        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let scanSessionId = null;
        let sessionToken = null;
        let allImagesForSession = [];

        // DOM elements
        const studentInfo = document.getElementById('studentInfo');
        const imagePreviews = document.getElementById('imagePreviews');
        const uploadBtn = document.getElementById('uploadBtn');
        const noImagesMessage = document.getElementById('noImagesMessage');
        const cameraInput = document.getElementById('cameraInput');
        const galleryInput = document.getElementById('galleryInput');
        const imageCount = document.getElementById('imageCount');

        // Utility to generate a unique ID for local image management
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            sessionToken = urlParams.get('token');

            if (!sessionToken) {
                studentInfo.textContent = 'Error: No session token provided.';
                return;
            }

            try {
                // Fetch scan session details using the Edge Function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/get-scan-session?token=${sessionToken}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load session');
                }

                const session = await response.json();
                scanSessionId = session.id;

                // Populate allImagesForSession with existing uploaded images from the session
                if (session.uploaded_image_paths && session.uploaded_image_paths.length > 0) {
                    allImagesForSession = session.uploaded_image_paths.map(url => ({
                        id: generateUUID(),
                        type: 'uploaded',
                        data: url
                    }));
                }

                studentInfo.textContent = `Student: ${session.student_name || session.student_number || 'Unknown'}`;
                renderPreviews();
                updateNoImagesMessage();
                updateUploadButton();
                updateImageCount();

            } catch (error) {
                console.error('Initialization error:', error);
                studentInfo.textContent = `Error: ${error.message}`;
            }
        });

        // Event listeners
        cameraInput.addEventListener('change', handleImageSelection);
        galleryInput.addEventListener('change', handleImageSelection);
        uploadBtn.addEventListener('click', uploadImages);

        /**
         * Handles when user selects images from camera/gallery
         */
        function handleImageSelection(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) return;

            // Add each selected file to our image collection
            files.forEach(file => {
                const newImage = {
                    id: generateUUID(),
                    type: 'new',
                    data: file
                };
                allImagesForSession.push(newImage);
            });

            // Clear the input so the same files can be selected again if needed
            event.target.value = '';

            renderPreviews();
            updateNoImagesMessage();
            updateUploadButton();
            updateImageCount();
        }

        /**
         * Updates the image count display
         */
        function updateImageCount() {
            const newImageCount = allImagesForSession.filter(item => item.type === 'new').length;
            const totalCount = allImagesForSession.length;
            
            if (totalCount > 0) {
                imageCount.classList.remove('hidden');
                if (newImageCount > 0) {
                    imageCount.textContent = `${newImageCount} new photo${newImageCount !== 1 ? 's' : ''} (${totalCount} total)`;
                    imageCount.classList.add('has-new');
                } else {
                    imageCount.textContent = `${totalCount} photo${totalCount !== 1 ? 's' : ''} uploaded`;
                    imageCount.classList.remove('has-new');
                }
            } else {
                imageCount.classList.add('hidden');
            }
        }

        /**
         * Renders all images in the preview section
         */
        function renderPreviews() {
            imagePreviews.innerHTML = '';

            updateNoImagesMessage();
            updateUploadButton();

            if (allImagesForSession.length === 0) {
                return;
            }

            allImagesForSession.forEach(item => {
                const previewItem = document.createElement('div');
                previewItem.className = `preview-item ${item.type === 'new' ? 'new-image' : ''}`;

                const img = document.createElement('img');
                img.src = item.type === 'new' ? URL.createObjectURL(item.data) : item.data;
                img.alt = 'Preview';

                const imageInfo = document.createElement('div');
                imageInfo.className = 'image-info';
                
                if (item.type === 'new') {
                    imageInfo.textContent = '‚óè NEW';
                } else {
                    imageInfo.textContent = 'Uploaded';
                }

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = () => removeImage(item.id);

                previewItem.appendChild(img);
                previewItem.appendChild(imageInfo);
                previewItem.appendChild(removeBtn);

                imagePreviews.appendChild(previewItem);

                // Revoke object URL for 'new' images after they are loaded to free memory
                if (item.type === 'new') {
                    img.onload = () => URL.revokeObjectURL(img.src);
                }
            });
        }

        /**
         * Updates the state of the main upload button
         */
        function updateUploadButton() {
            const hasNewImages = allImagesForSession.some(item => item.type === 'new');
            uploadBtn.disabled = !hasNewImages;
            
            if (hasNewImages) {
                const newCount = allImagesForSession.filter(item => item.type === 'new').length;
                uploadBtn.textContent = `Upload ${newCount} New Image${newCount !== 1 ? 's' : ''}`;
            } else {
                uploadBtn.textContent = 'No New Images to Upload';
            }
        }

        /**
         * Toggles the visibility of the "No images uploaded yet" message
         */
        function updateNoImagesMessage() {
            const hasImages = allImagesForSession.length > 0;
            noImagesMessage.classList.toggle('hidden', hasImages);
        }

        /**
         * Uploads all newly captured images to Supabase Storage
         */
        async function uploadImages() {
            const newFilesToUpload = allImagesForSession.filter(item => item.type === 'new');

            if (newFilesToUpload.length === 0) {
                return;
            }

            uploadBtn.disabled = true;
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'Uploading...';
            uploadBtn.classList.add('loading');

            try {
                const uploadedUrls = [];
                let uploadedCount = 0;

                for (const item of newFilesToUpload) {
                    const file = item.data;
                    const fileExt = file.name.split('.').pop() || 'jpg';
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `temp_scans/${sessionToken}/${fileName}`;

                    // Update progress
                    uploadBtn.textContent = `Uploading... (${uploadedCount + 1}/${newFilesToUpload.length})`;

                    // Upload file to Supabase Storage
                    const { error: uploadError } = await sb.storage
                        .from(STORAGE_BUCKET)
                        .upload(filePath, file);

                    if (uploadError) throw uploadError;

                    // Get public URL of the uploaded file
                    const { data: urlData } = sb.storage
                        .from(STORAGE_BUCKET)
                        .getPublicUrl(filePath);

                    uploadedUrls.push(urlData.publicUrl);

                    // Update the item's type and data in our local array
                    item.type = 'uploaded';
                    item.data = urlData.publicUrl;

                    uploadedCount++;
                }

                // Fetch current uploaded_image_paths from DB to merge with new ones
                const { data: currentSessionData, error: fetchError } = await sb
                    .from('scan_sessions')
                    .select('uploaded_image_paths')
                    .eq('id', scanSessionId)
                    .single();

                if (fetchError) throw fetchError;

                const existingPaths = currentSessionData.uploaded_image_paths || [];
                const updatedPaths = [...existingPaths, ...uploadedUrls];

                // Update the scan_sessions table with the merged list of image paths
                const { error: updateError } = await sb
                    .from('scan_sessions')
                    .update({ uploaded_image_paths: updatedPaths })
                    .eq('id', scanSessionId);

                if (updateError) throw updateError;

                renderPreviews();
                updateUploadButton();
                updateImageCount();

                // Show success message
                uploadBtn.textContent = `‚úì ${uploadedCount} Image${uploadedCount !== 1 ? 's' : ''} Uploaded Successfully!`;
                setTimeout(() => {
                    updateUploadButton(); // Reset to normal state
                    uploadBtn.classList.remove('loading');
                }, 3000);

            } catch (error) {
                console.error('Upload error:', error);
                uploadBtn.textContent = `Upload Failed - Try Again`;
                setTimeout(() => {
                    uploadBtn.textContent = originalText;
                    uploadBtn.classList.remove('loading');
                }, 3000);
            }
        }

        /**
         * Removes an image from the local list and storage/DB if uploaded
         */
        async function removeImage(idToRemove) {
            const indexToRemove = allImagesForSession.findIndex(item => item.id === idToRemove);
            if (indexToRemove === -1) return;

            const itemToRemove = allImagesForSession[indexToRemove];

            if (itemToRemove.type === 'uploaded') {
                const urlToRemove = itemToRemove.data;
                const filename = urlToRemove.split('/').pop();
                const filePath = `temp_scans/${sessionToken}/${filename}`;

                try {
                    // Delete from Supabase Storage
                    const { error: deleteError } = await sb.storage.from(STORAGE_BUCKET).remove([filePath]);
                    if (deleteError) throw deleteError;

                    // Fetch current paths from DB
                    const { data: currentSessionData, error: fetchError } = await sb
                        .from('scan_sessions')
                        .select('uploaded_image_paths')
                        .eq('id', scanSessionId)
                        .single();

                    if (fetchError) throw fetchError;

                    const existingPaths = currentSessionData.uploaded_image_paths || [];
                    const updatedPaths = existingPaths.filter(path => path !== urlToRemove);

                    // Update the scan_sessions table
                    const { error: updateError } = await sb
                        .from('scan_sessions')
                        .update({ uploaded_image_paths: updatedPaths })
                        .eq('id', scanSessionId);

                    if (updateError) throw updateError;

                } catch (error) {
                    console.error('Remove image error:', error);
                    return;
                }
            }

            // Remove from local array and re-render
            allImagesForSession.splice(indexToRemove, 1);
            renderPreviews();
            updateImageCount();
        }
    </script>
</body>
</html>
