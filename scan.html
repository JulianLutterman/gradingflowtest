<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Student Answers</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
            background: #f8f9fa;
        }

        .student-info {
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Camera interface styles */
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            margin: 20px auto;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .camera-container.inactive {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .camera-icon-large {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .camera-instructions {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .camera-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        #cameraFeed {
            width: 100%;
            height: auto;
            display: block;
            max-height: 70vh;
            object-fit: cover;
        }

        .camera-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 30px 20px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn:disabled:hover {
            transform: none;
        }

        #takePhotoBtn {
            width: 80px;
            height: 80px;
            background: white;
            border: 4px solid rgba(255,255,255,0.3);
            font-size: 32px;
        }

        .start-camera-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
            transition: all 0.3s ease;
        }

        .start-camera-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.5);
        }

        .start-camera-btn:active {
            transform: translateY(0);
        }

        /* Flash effect */
        .camera-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .camera-flash.active {
            animation: flashEffect 0.2s ease-out;
        }

        @keyframes flashEffect {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        /* Photo counter */
        .photo-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        /* Alternative upload section */
        .upload-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .upload-section h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        .file-input-label {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .file-input-label:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        /* Upload button */
        .upload-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .upload-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Preview grid */
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .preview-item {
            position: relative;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .preview-item:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 123, 255, 0.2);
        }

        .preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .preview-item .image-info {
            padding: 8px 12px;
            font-size: 12px;
            text-align: center;
            font-weight: bold;
        }

        .preview-item.new-image {
            border-color: #28a745;
        }

        .preview-item.new-image .image-info {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .preview-item.uploaded-image .image-info {
            background: #f8f9fa;
            color: #6c757d;
        }

        .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .no-images-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
            background: white;
            border-radius: 12px;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        /* Responsive adjustments */
        @media (min-width: 600px) {
            .preview-container {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .preview-item img {
                height: 140px;
            }
        }

        /* Loading animation */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>

    <div id="studentInfo" class="student-info">Loading...</div>

    <!-- Camera Interface -->
    <div id="cameraContainer" class="camera-container inactive">
        <div id="cameraInactive" class="camera-inactive">
            <div class="camera-icon-large">üì∑</div>
            <div class="camera-instructions">Take Multiple Photos</div>
            <div class="camera-subtitle">
                Start the camera to take high-quality photos.<br>
                You can take as many as you need without leaving this page.
            </div>
            <button id="startCameraBtn" class="start-camera-btn">
                üé• Start Camera
            </button>
        </div>
        
        <video id="cameraFeed" class="hidden" autoplay playsinline muted></video>
        <canvas id="captureCanvas" class="hidden"></canvas>
        
        <div id="cameraControls" class="camera-controls hidden">
            <button id="switchCameraBtn" class="control-btn" title="Switch Camera">
                üîÑ
            </button>
            <button id="takePhotoBtn" class="control-btn" title="Take Photo">
                üì∏
            </button>
            <button id="stopCameraBtn" class="control-btn" title="Stop Camera">
                ‚ùå
            </button>
        </div>
        
        <div id="photoCounter" class="photo-counter hidden">
            0 photos taken
        </div>
        
        <div id="cameraFlash" class="camera-flash"></div>
    </div>

    <!-- Alternative Upload Section -->
    <div class="upload-section">
        <h3>Or Select Existing Photos</h3>
        <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept="image/*" multiple>
            <label for="fileInput" class="file-input-label">
                üìÅ Choose Files
            </label>
        </div>
    </div>

    <!-- Upload Button -->
    <button id="uploadBtn" class="upload-btn" disabled>
        No New Images to Upload
    </button>

    <!-- Preview Area -->
    <div id="noImagesMessage" class="no-images-message">
        No images captured yet. Use the camera above or select existing photos.
    </div>

    <div id="imagePreviews" class="preview-container"></div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://uagiatfoiwusxafxskvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhZ2lhdGZvaXd1c3hhZnhza3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyODc0NjYsImV4cCI6MjA2NDg2MzQ2Nn0.b0wIEHgENkhzkp3qHAotqbLTq7BwsqgM7b0ksAl3h1U';
        const STORAGE_BUCKET = 'exam-visuals';

        // Initialize Supabase client
        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let scanSessionId = null;
        let sessionToken = null;
        let allImagesForSession = [];
        let cameraStream = null;
        let currentFacingMode = 'environment';
        let availableCameras = [];

        // DOM elements
        const studentInfo = document.getElementById('studentInfo');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraInactive = document.getElementById('cameraInactive');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const cameraFeed = document.getElementById('cameraFeed');
        const captureCanvas = document.getElementById('captureCanvas');
        const cameraControls = document.getElementById('cameraControls');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const photoCounter = document.getElementById('photoCounter');
        const cameraFlash = document.getElementById('cameraFlash');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const noImagesMessage = document.getElementById('noImagesMessage');
        const imagePreviews = document.getElementById('imagePreviews');

        // Utility functions
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function updatePhotoCounter() {
            const newPhotos = allImagesForSession.filter(img => img.type === 'new').length;
            const total = allImagesForSession.length;
            
            if (total > 0) {
                photoCounter.textContent = `${newPhotos} new photos (${total} total)`;
                photoCounter.classList.remove('hidden');
            } else {
                photoCounter.classList.add('hidden');
            }
        }

        function updateUploadButton() {
            const newImages = allImagesForSession.filter(img => img.type === 'new');
            
            if (newImages.length > 0) {
                uploadBtn.disabled = false;
                uploadBtn.textContent = `Upload ${newImages.length} New Image${newImages.length !== 1 ? 's' : ''}`;
            } else {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'No New Images to Upload';
            }
        }

        function updateNoImagesMessage() {
            noImagesMessage.classList.toggle('hidden', allImagesForSession.length > 0);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            sessionToken = urlParams.get('token');

            if (!sessionToken) {
                studentInfo.textContent = 'Error: No session token provided.';
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/get-scan-session?token=${sessionToken}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load session');
                }

                const session = await response.json();
                scanSessionId = session.id;

                if (session.uploaded_image_paths && session.uploaded_image_paths.length > 0) {
                    allImagesForSession = session.uploaded_image_paths.map(url => ({
                        id: generateUUID(),
                        type: 'uploaded',
                        data: url
                    }));
                }

                studentInfo.textContent = `Student: ${session.student_name || session.student_number || 'Unknown'}`;
                renderPreviews();
                updateNoImagesMessage();
                updateUploadButton();
                updatePhotoCounter();

            } catch (error) {
                console.error('Initialization error:', error);
                studentInfo.textContent = `Error: ${error.message}`;
            }
        });

        // Event listeners
        startCameraBtn.addEventListener('click', startCamera);
        takePhotoBtn.addEventListener('click', takePhoto);
        switchCameraBtn.addEventListener('click', switchCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        fileInput.addEventListener('change', handleFileSelection);
        uploadBtn.addEventListener('click', uploadImages);

        // Camera functions
        async function startCamera() {
            try {
                // Get available cameras
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                // Show/hide switch camera button based on available cameras
                switchCameraBtn.style.display = availableCameras.length > 1 ? 'flex' : 'none';

                await initializeCamera();
                
                // Update UI
                cameraContainer.classList.remove('inactive');
                cameraInactive.classList.add('hidden');
                cameraFeed.classList.remove('hidden');
                cameraControls.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error starting camera:', error);
                alert('Failed to start camera. Please check permissions and try again.');
            }
        }

        async function initializeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: currentFacingMode,
                    width: { min: 1280, ideal: 1920, max: 4096 },
                    height: { min: 720, ideal: 1080, max: 4096 },
                    frameRate: { ideal: 30 }
                }
            };

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = cameraStream;
            } catch (error) {
                // Fallback to basic constraints
                const basicConstraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 }
                    }
                };
                cameraStream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                cameraFeed.srcObject = cameraStream;
            }
        }

        async function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            await initializeCamera();
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            cameraContainer.classList.add('inactive');
            cameraInactive.classList.remove('hidden');
            cameraFeed.classList.add('hidden');
            cameraControls.classList.add('hidden');
            cameraFeed.srcObject = null;
        }

        function takePhoto() {
            if (!cameraStream) return;

            // Flash effect
            cameraFlash.classList.add('active');
            setTimeout(() => cameraFlash.classList.remove('active'), 200);

            // Capture photo
            const context = captureCanvas.getContext('2d');
            captureCanvas.width = cameraFeed.videoWidth;
            captureCanvas.height = cameraFeed.videoHeight;
            
            context.drawImage(cameraFeed, 0, 0);
            
            captureCanvas.toBlob(blob => {
                if (blob) {
                    const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                    const newImage = {
                        id: generateUUID(),
                        type: 'new',
                        data: file
                    };
                    
                    allImagesForSession.push(newImage);
                    renderPreviews();
                    updatePhotoCounter();
                    updateUploadButton();
                    updateNoImagesMessage();
                }
            }, 'image/jpeg', 0.95);
        }

        // File selection
        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                const newImage = {
                    id: generateUUID(),
                    type: 'new',
                    data: file
                };
                allImagesForSession.push(newImage);
            });

            event.target.value = '';
            renderPreviews();
            updatePhotoCounter();
            updateUploadButton();
            updateNoImagesMessage();
        }

        // Render previews
        function renderPreviews() {
            imagePreviews.innerHTML = '';

            allImagesForSession.forEach(item => {
                const previewItem = document.createElement('div');
                previewItem.className = `preview-item ${item.type === 'new' ? 'new-image' : 'uploaded-image'}`;

                const img = document.createElement('img');
                img.src = item.type === 'new' ? URL.createObjectURL(item.data) : item.data;
                img.alt = 'Preview';

                const imageInfo = document.createElement('div');
                imageInfo.className = 'image-info';
                imageInfo.textContent = item.type === 'new' ? '‚óè NEW' : 'Uploaded';

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = () => removeImage(item.id);

                previewItem.appendChild(img);
                previewItem.appendChild(imageInfo);
                previewItem.appendChild(removeBtn);
                imagePreviews.appendChild(previewItem);

                if (item.type === 'new') {
                    img.onload = () => URL.revokeObjectURL(img.src);
                }
            });
        }

        // Upload images
        async function uploadImages() {
            const newFilesToUpload = allImagesForSession.filter(item => item.type === 'new');
            if (newFilesToUpload.length === 0) return;

            uploadBtn.disabled = true;
            const originalText = uploadBtn.textContent;
            uploadBtn.classList.add('loading');

            try {
                const uploadedUrls = [];
                let uploadedCount = 0;

                for (const item of newFilesToUpload) {
                    uploadBtn.textContent = `Uploading... (${uploadedCount + 1}/${newFilesToUpload.length})`;
                    
                    const file = item.data;
                    const fileExt = file.name.split('.').pop() || 'jpg';
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `temp_scans/${sessionToken}/${fileName}`;

                    const { error: uploadError } = await sb.storage
                        .from(STORAGE_BUCKET)
                        .upload(filePath, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = sb.storage
                        .from(STORAGE_BUCKET)
                        .getPublicUrl(filePath);

                    uploadedUrls.push(urlData.publicUrl);
                    item.type = 'uploaded';
                    item.data = urlData.publicUrl;
                    uploadedCount++;
                }

                // Update database
                const { data: currentSessionData, error: fetchError } = await sb
                    .from('scan_sessions')
                    .select('uploaded_image_paths')
                    .eq('id', scanSessionId)
                    .single();

                if (fetchError) throw fetchError;

                const existingPaths = currentSessionData.uploaded_image_paths || [];
                const updatedPaths = [...existingPaths, ...uploadedUrls];

                const { error: updateError } = await sb
                    .from('scan_sessions')
                    .update({ uploaded_image_paths: updatedPaths })
                    .eq('id', scanSessionId);

                if (updateError) throw updateError;

                renderPreviews();
                updateUploadButton();
                updatePhotoCounter();

                uploadBtn.textContent = `‚úì ${uploadedCount} Image${uploadedCount !== 1 ? 's' : ''} Uploaded!`;
                setTimeout(() => {
                    updateUploadButton();
                    uploadBtn.classList.remove('loading');
                }, 3000);

            } catch (error) {
                console.error('Upload error:', error);
                uploadBtn.textContent = 'Upload Failed - Try Again';
                uploadBtn.classList.remove('loading');
                setTimeout(() => {
                    uploadBtn.textContent = originalText;
                }, 3000);
            }
        }

        // Remove image
        async function removeImage(idToRemove) {
            const indexToRemove = allImagesForSession.findIndex(item => item.id === idToRemove);
            if (indexToRemove === -1) return;

            const itemToRemove = allImagesForSession[indexToRemove];

            if (itemToRemove.type === 'uploaded') {
                try {
                    const urlToRemove = itemToRemove.data;
                    const filename = urlToRemove.split('/').pop();
                    const filePath = `temp_scans/${sessionToken}/${filename}`;

                    const { error: deleteError } = await sb.storage.from(STORAGE_BUCKET).remove([filePath]);
                    if (deleteError) throw deleteError;

                    const { data: currentSessionData, error: fetchError } = await sb
                        .from('scan_sessions')
                        .select('uploaded_image_paths')
                        .eq('id', scanSessionId)
                        .single();

                    if (fetchError) throw fetchError;

                    const existingPaths = currentSessionData.uploaded_image_paths || [];
                    const updatedPaths = existingPaths.filter(path => path !== urlToRemove);

                    const { error: updateError } = await sb
                        .from('scan_sessions')
                        .update({ uploaded_image_paths: updatedPaths })
                        .eq('id', scanSessionId);

                    if (updateError) throw updateError;

                } catch (error) {
                    console.error('Remove image error:', error);
                    return;
                }
            }

            allImagesForSession.splice(indexToRemove, 1);
            renderPreviews();
            updatePhotoCounter();
            updateUploadButton();
            updateNoImagesMessage();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
